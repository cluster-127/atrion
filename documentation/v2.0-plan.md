# Atrion v2.0 Implementation Plan

## Overview

v2.0 introduces **Pluggable State Architecture** (RFC-0008), enabling cluster-aware state sharing.

---

## Breaking Changes

| v1.x                       | v2.0                     | Migration          |
| -------------------------- | ------------------------ | ------------------ |
| `updatePhysics()` function | `Atrion` class instance  | Create singleton   |
| Stateless functions        | Stateful instance        | Wrap in class      |
| Implicit InMemory          | Explicit `StateProvider` | Add provider param |

---

## Implementation Phases

### Phase 1: Core Interfaces (Week 1)

```
src/core/state/
├── types.ts       # StateProvider, PhysicsVector interfaces
├── manager.ts     # StateManager class
└── index.ts       # Exports
```

**Deliverables:**

- [ ] `StateProvider` interface
- [ ] `PhysicsVector` type
- [ ] `StateManager` class with local cache

---

### Phase 2: InMemoryProvider (Week 2)

```
src/core/state/providers/
└── inmemory.ts    # Default provider (free)
```

**Deliverables:**

- [ ] `InMemoryProvider` implementation
- [ ] Unit tests
- [ ] Migration guide draft

---

### Phase 3: Atrion Class (Week 2-3)

```
src/atrion.ts      # Main entry point
```

**Deliverables:**

- [ ] `Atrion` class wrapping physics
- [ ] Constructor with `StateProvider` option
- [ ] Backward-compatible `updatePhysics()` static method

---

### Phase 4: AutoTuner Integration (Week 3)

**Deliverables:**

- [ ] AutoTuner enabled by default
- [ ] Config migration (breakMultiplier → adaptive)
- [ ] Telemetry: μ, σ, dynamicBreak

---

### Phase 5: OpenTelemetry (Week 4)

```
src/integrations/
└── otel.ts        # OpenTelemetry adapter
```

**Deliverables:**

- [ ] Metrics export (resistance, scar, mode)
- [ ] Trace context propagation

---

## Testing Strategy

| Type        | Target                  |
| ----------- | ----------------------- |
| Unit        | StateProvider interface |
| Integration | Provider sync           |
| Lab         | Cluster simulation      |

---

## Timeline

| Week | Milestone                       |
| ---- | ------------------------------- |
| 1    | Interface definitions           |
| 2    | InMemoryProvider + Atrion class |
| 3    | AutoTuner default + tests       |
| 4    | OTel + v2.0.0-alpha release     |

---

## Success Criteria

- [ ] All 114 existing tests pass
- [ ] New tests for StateProvider (20+)
- [ ] Zero breaking changes for users using defaults
- [ ] Migration guide complete
